---
title: Google Testを使うためのMakefile
tags:
  - ShellScript
  - C++
  - Bash
  - Makefile
  - googletest
private: false
updated_at: '2025-12-04T19:27:12+09:00'
id: 08ec6d2fd151ebc6d079
organization_url_name: null
slide: false
ignorePublish: false
---
## 前記事
https://qiita.com/skkzsh/items/f9a619a9084cbd88bf15

:::note
前記事の続きですが, いちおう単独で読めると思います.
本記事では Google Test を使うための `Makefile` を順を追って説明しながら完成させていきます.
:::

https://github.com/google/googletest

## Makefileにコンパイラとオプションだけを書く

まず下記のようにコンパイラとオプションを `Makefile` に書く.

```make:コンパイラとオプションだけのMakefile
CXX := g++
CXXFLAGS := -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread
```

これで `make` でコンパイルし, テストを実行できるようになる.

```console
$ make solution_7_1
g++ -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread   solution_7_1.cpp   -o solution_7_1

$ ./solution_7_1
Running main() from /tmp/googletest-20220910-4336-bl42bb/googletest-release-1.12.1/googletest/src/gtest_main.cc
[==========] Running 5 tests from 1 test suite.
[----------] Global test environment set-up.
[----------] 5 tests from Inst/TestSuite
[ RUN      ] Inst/TestSuite.Ex/0
[       OK ] Inst/TestSuite.Ex/0 (0 ms)
[ RUN      ] Inst/TestSuite.Ex/1
[       OK ] Inst/TestSuite.Ex/1 (0 ms)
[ RUN      ] Inst/TestSuite.Ex/2
[       OK ] Inst/TestSuite.Ex/2 (0 ms)
[ RUN      ] Inst/TestSuite.Ex/3
[       OK ] Inst/TestSuite.Ex/3 (0 ms)
[ RUN      ] Inst/TestSuite.Ex/4
[       OK ] Inst/TestSuite.Ex/4 (0 ms)
[----------] 5 tests from Inst/TestSuite (0 ms total)

[----------] Global test environment tear-down
[==========] 5 tests from 1 test suite ran. (1 ms total)
[  PASSED  ] 5 tests.
```

## Makefileにターゲットを書く

`make` にターゲットを渡さずにコンパイル, そして複数ファイルに対応させるには,
`Makefile` に下記のようにターゲットを書く. [^1]

[^1]: [`basename`](https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html#index-basename-1) は拡張子を取り除いた文字列を返す組込関数

```diff_make:ターゲットを書いたMakefile
CXX := g++
CXXFLAGS := -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread
+
+ TARGETS := $(basename $(wildcard solution_[1-9]*_[1-9]*.cpp))  # ワイルドカードは適宜変更
+
+ .PHONY: clean
+
+ all: $(TARGETS)
+
+ clean:
+  	$(RM) $(TARGETS)
```

これで, `make` を実行するだけで複数のテストコードを一発でコンパイルできる. [^2]

[^2]: [`-j`](https://www.gnu.org/software/make/manual/html_node/Options-Summary.html#index-_002d_002djobs-1) オプションをつけると並列化できる (`-j`の後の数字は並列数)

```console
$ make -j4
g++ -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread    solution_7_1.cpp   -o solution_7_1
g++ -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread    solution_7_2.cpp   -o solution_7_2
g++ -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread    solution_7_3.cpp   -o solution_7_3
.
.
.
(略)
```

## 全テスト実行もできるMakefileにする

テストを一発で全部実行したい場合, `Makefile` やスクリプトを下記のように書けば,
`make testall` で実行できるようになる.

```diff_make:全テスト実行もできるMakefile
CXX := g++
CXXFLAGS := -Wall -Wextra -std=c++20 -lgtest_main -lgtest -lpthread

TARGETS := $(basename $(wildcard solution_[1-9]*_[1-9]*.cpp))  # ワイルドカードは適宜変更

- .PHONY: clean
+ .PHONY: testall clean

all: $(TARGETS)

+ testall: $(TARGETS)
+	./runall.sh $(TARGETS)
+
clean:
	$(RM) $(TARGETS)
```

```bash:runall.sh
#!/bin/bash

exit_code=0  # 初期化

for t in $@; do
  ./$t
  exit_code=$(( $exit_code | $? ))  # 1つでもexit codeが1となれば1を返す
done

exit $exit_code
```

## 続き
複数ファイルで使うアルゴリズムやデータ構造を, 共通のソースファイルとヘッダファイルに切り出すときの `Makefile` については以下の記事に続く.

https://qiita.com/skkzsh/items/056e88c1aaa5b68075bb

CIでの実行については, 以下の記事に続く.

https://qiita.com/skkzsh/items/254a22e5452ba3f8d854
