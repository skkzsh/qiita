---
title: レジストリファイル (UTF-16) をdiffやGitで扱う
tags:
  - Windows
  - Git
  - diff
private: false
updated_at: '2025-12-04T19:14:50+09:00'
id: bf873227bd8184b26bcf
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

```console
$ file foo.reg
foo.reg: Little-endian UTF-16 Unicode text, with CRLF line terminators
```

レジストリファイル (.reg) はテキストファイルであるが,
**UTF-16**は, 以下のようにバイナリとして認識されてしまうため, 適切に処理できない.

```console
$ less foo.reg
"foo.reg" may be a binary file.  See it anyway?

$ grep HKEY foo.reg # 何も出力されない

$ sed 's/HKEY/hkey/g' foo.reg # 変換されない

$ diff foo.reg bar.reg
Binary files foo.reg and bar.reg differ

$ git grep HKEY # 何も出力されない

$ git diff
Binary files a/foo.reg and b/foo.reg differ
```

テキスト処理したり, Gitで管理できるようにするためには, `nkf`でUTF-8に変換すればいい.


## UTF-16をdiff

プロセス置換でUTF-8に変換してから, `diff`に渡す.

```console
$ diff <( nkf -w foo.reg ) <( nkf -w bar.reg )
```

なお, `vim`はUTF-16のファイルを見ることができるので, `vimdiff`を使ってもいい.


## UTF-16でGit

まず, 以下のように, UTF-8に変換する[フィルタ](https://git-scm.com/docs/git-diff#Documentation/git-diff.txt-diffltdrivergttextconv)を設定する.

```console
$ git config --global diff.to_utf8.textconv 'nkf -w'
```

そうすると, `~/.gitconfig`に以下のような行が追加されている.

```~/.gitconfig
[diff "to_utf8"]
    textconv = nkf -w
```

このフィルタを`*.reg`に適用したい場合は, [`.gitattributes`](https://git-scm.com/docs/gitattributes#_performing_text_diffs_of_binary_files)に以下の行を追加する.

```:.gitattributes
*.reg diff=to_utf8
```

以上により, `git diff`する前に, `*.reg`のファイルは`nkf`でUTF-8に変換されるため,
レジストリファイルも`git diff`で見ることができるようになる.

`git grep`も[`--textconv`](https://git-scm.com/docs/git-grep#Documentation/git-grep.txt---textconv)オプションで見ることができる.

```console
$ git grep --textconv HKEY # 出力される
```

## 参考

https://git-scm.com/docs/gitattributes#_performing_text_diffs_of_binary_files

https://blog.tkeo.info/blog/2015/02/26/git-diff-utf-16/

https://genjiapp.com/blog/2014/07/26/git-diff-utf-16-text-files.html
